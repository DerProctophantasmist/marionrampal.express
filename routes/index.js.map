{
  "version": 3,
  "file": "index.js",
  "sourceRoot": "../../../../extra/cloud/express.marionrampal",
  "sources": [
    "../../../martin/cloud/express.marionrampal/routes/index.coffee"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "express = require('express')\nrouter = express.Router()\n\nlog = require('../helpers/logger').mainLogger\nVErr = require('verror')\nhbs = require('hbs')\n\n\n\nhttpContext = require('express-http-context')\n\n{globalCache,getNbrOfSections} = require('../helpers/cache')\n\nsections = require('../helpers/sections')\n\n\nhbs.registerHelper('description', () ->\n  page = this.page ? sections.head?.id\n  return sections.data[page]?.description?[this.curLang]\n)\n\n\nhbs.registerHelper('websiteTitle', () ->\n  page = this.page ? sections.head?.id\n  title = sections.data[page]?.title ? sections.data[page]?.name\n  return title?[this.curLang]\n)\n\n\n \nhbs.registerHelper('includeRoot', (filename) ->\n  log.info {curLang:this.curLang, httpContextLang: httpContext.get('curLang')}\n  if this.allowEdit == \"false\"  \n    if this.cache\n      return new hbs.SafeString cache  \n    return new hbs.SafeString \"\"\"\n      <marked compile=\"true\" filename=\"'#{filename}'\"></marked>\n      \"\"\"    \n  return new hbs.SafeString(\"\"\"\n    <marked compile=\"true\" filename=\"'#{filename}'\"  editor-button-style=\"position:absolute;top:2em;left:0;color:black;z-index:1000;\"></marked>\n    \"\"\"\n  )\n)\n\nlanguage = (req,res,next) ->\n  log = require('../helpers/logger').requestLogger(req)\n  fbLang = req.get('X-Facebook-Locale')\n  if cookieLang = req.cookies[\"marionrampal.locale\"]\n    cookieLang = cookieLang.substring(0,2)\n    log.info {cookieLang: cookieLang}\n\n  res.locals.prefLang = cookieLang ? req.acceptsLanguages('fr','en') ? fbLang ? 'en'\n\n  forceLang = req.query.forceLang\n  if forceLang == \"\" then forceLang = null\n  res.locals.forceLang = forceLang\n  res.locals.curLang =  forceLang ? fbLang ? res.locals.prefLang\n\n  httpContext.set('curLang',res.locals.curLang)\n  next()\n\ncache = (req,res,next) -> \n  next()\n\nonInit = (_,config) ->\n  log.info({config}, \"configuration object\")\n  # GET home page. \n  router.get('/', httpContext.middleware, language, cache, (req, res, next) ->\n    log = require('../helpers/logger').requestLogger(req)\n    cache = null\n    nbrOfSections = 0\n\n    basePath = req.query.path\n    basePath = (if basePath?  then basePath else '') + '/'\n    allowEdit = (if basePath == '/staging/' then 'true' else 'false')\n    if allowEdit == \"false\"\n      cache = globalCache[this.curLang]\n      if !cache \n        log.error new VErr(), \"content was not cached\"\n      nbrOfSections = getNbrOfSections() \n\n    log.info { 'query path': basePath}\n    page = req.query.page\n    if page == \"\" then page = null\n    res.render('index', { allowEdit, basePath , page , bannerTitle: config.bannerTitle,  mainPage: config.mainPage, compileDate:config.compileDate, cache, nbrOfSections  })\n    return\n  )\n\nrequire('../helpers/init').readConfig(onInit)\n \nmodule.exports = router\n\n"
  ]
}